<?php/** * * * Zenbership Membership Software * Copyright (C) 2013-2016 Castlamp, LLC * * This program is free software: you can redistribute it and/or modify * it under the terms of the GNU General Public License as published by * the Free Software Foundation, either version 3 of the License, or * (at your option) any later version. * * This program is distributed in the hope that it will be useful, * but WITHOUT ANY WARRANTY; without even the implied warranty of * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the * GNU General Public License for more details. * * You should have received a copy of the GNU General Public License * along with this program.  If not, see <http://www.gnu.org/licenses/>. * * @author      Castlamp * @link        http://www.castlamp.com/ * @link        http://www.zenbership.com/ * @copyright   (c) 2013-2016 Castlamp * @license     http://www.gnu.org/licenses/gpl-3.0.en.html * @project     Zenbership Membership Software */// Check permissions, ownership,// and if it exists.$permission = 'invoice-add';$check = $admin->check_permissions($permission, $employee);if ($check != '1') {    $admin->show_no_permissions($error, '', '1');} else {    $cid = generate_id($db->get_option('invoice_id_format'));?>    <script type="text/javascript">        $.ctrl('S', function () {            return json_add('invoice-add', '<?php echo $cid; ?>', '0', 'popupform');        });    </script>    <form action="" method="post" id="popupform"          onsubmit="return json_add('invoice-add','<?php echo $cid; ?>','0','popupform');">    <div id="popupsave">        <input type="submit" value="Save" class="save"/>    </div>    <h1>Creating Invoice</h1>    <div class="popupbody">    <ul id="step_tabs" class="popup_tabs">        <li class="on">            Basics        </li><li>            Line Items        </li><li>            Memo        </li><li>            Shipping        </li>    </ul>    <input type="hidden" name="id" value="<?php echo $cid; ?>"/>        <!--start:step 1-->    <div id="step_1" class="step_form fullForm">        <div class="highlight">            Create an invoice using the form below. Additional options are available in the tabs above.        </div>        <fieldset>            <div class="pad24t">                <div class="col33l">                    <label class="less">When is this due?</label>                    <div class="field_entry_less">                        <?php                        echo $af                            ->setSpecialType('date')                            ->string('data[due_date]', '', 'req');                        ?>                    </div>                    <label class="less">What is the hourly rate for this invoice?</label>                        <?php                        $field = $af                            ->setRightText('/hour')                            ->string('data[hourly_rate]', $db->get_option('invoice_hourly'), 'req');                        echo place_currency($field);                        ?>                    <label class="less">What is the tax rate for this invoice?</label>                    <?php                    echo $af                        ->setRightText('%')                        ->string('data[tax_rate]', '', '', '8.00');                    ?>                </div>                <div class="col66r">                    <label>How should notifications be handled?</label>                    <div class="radioInputs">                        <input type="radio" name="data[auto_inform]" id="radio1" value="1" checked/>                        <label class="checking" for="radio1">Zenbership should automatically send the invoice and notifications of changes to the invoiced party.</label>                        <input type="radio" name="data[auto_inform]" id="radio2" value="0" checked="checked"/>                        <label class="checking" for="radio2">I will manually send the invoice and notifications to the invoiced party.</label>                    </div>                    <label class="less">Who is being invoiced?</label>                    <?php                    $member_add = '';                    $contact_add = '';                    $member_username = '';                    $contact_name = '';                    $contact_id = '';                    $member_id = '';                    if (! empty($_POST['uid'])) {                        if ($_POST['utype'] == 'member') {                            $member_add = $_POST['uid'];                            $user = new user;                            $cdata = $user->get_user($_POST['uid']);                            if (! empty($cdata['data']['id'])) {                                $member_username = $cdata['data']['username'];                                $member_id = $_POST['uid'];                            } else {                                $default = '1';                                $member_id = '';                                $member_username = '';                            }                        } else {                            $contact_add = $_POST['uid'];                            $contact = new contact;                            $cdata = $contact->get_contact($_POST['uid']);                            if (! empty($cdata['data']['id'])) {                                $contact_name = $cdata['data']['last_name'] . ', ' . $cdata['data']['first_name'];                                $contact_id = $_POST['uid'];                            } else {                                $default = '1';                                $contact_add = '';                                $contact_id = '';                            }                            $member_username = '';                        }                        $default = '0';                    } else {                        $default = '1';                    }                    ?>                    <?php                    $options = array(                        'member' => 'An existing member',                        'contact' => 'An existing contact',                        'new_contact' => 'A new contact',                    );                    echo $af->radio('data[member_type]', 'member', $options);                    ?>                    <div id="member" style="display:<?php                    if (! empty($member_add)) { echo "block"; }                    else if ($default == '1') { echo "block"; }                    else { echo "none"; }                    ?>;">                    <img src="imgs/arrow-down.png" class="lookDown" />                    <label>Find the invoiced party below...</label>                    <?php                    echo $af->memberList('data[member_id]', $member_id);                    ?>                    </div>                    <div id="contact" style="display:<?php                    if (! empty($contact_add)) { echo "block"; }                    else { echo "none"; }                    ?>;">                    <img src="imgs/arrow-down.png" class="lookDown" />                    <label>Find the invoiced party below...</label>                    <?php                    echo $af->contactList('data[contact_id]', $contact_id);                    ?>                    </div>                </div>                <div class="clear"></div>            </div>        </fieldset>        <fieldset id="new_contact" style="display:none;">            <legend>Create a New Contact To Invoice</legend>            <div class="pad24t">                <div class="col33l">                    <label>Company</label>                    <?php                    echo $af->string('billing[company_name]', '', '', 'Company Name');                    echo $af                        ->string('billing[website]', '', '', 'http://www.companywebsite.com');                    ?>                    <label>Contact Details</label>                    <?php                    echo $af                        ->setSpecialType('tel')                        ->string('billing[phone]', '', '', 'Phone: 555-123-1234');                    echo $af                        ->setSpecialType('tel')                        ->string('billing[fax]', '', '', 'Fax: 555-123-1234');                    echo $af                        ->setSpecialType('email')                        ->string('billing[email]', '', '', 'person@somewhere.com');                    ?>                </div>                <div class="col66r">                    <label>Address</label>                    <?php                    echo $af->addressForm('billing');                    ?>                </div>                <div class="clear"></div>            </div>        </fieldset>    </div>    <!--end:step 1-->    <!--start:step 2-->    <div id="step_2" class="step_form" style="display:none;">        <p class="highlight bringTop">Item lines are the products that you're charing the user for. Note that you can also add components to the invoice later.</p>        <table cellspacing="0" class="generic" cellpadding="0" border="0" id="components">            <thead>            <tr>            <th>Item</th>            <th width="80">Qty</th>            <th width="120">Unit Price</th>            <th width="35">Tax</th>            <th width="25"></th>            </thead>            <tbody></tbody>        </table>        <div class="submit">            <input type="button" value="Add Existing Product" onclick="return add_existing_product();" />            <input type="button" value="Create Hourly Item" onclick="return add_hourly();" />            <input type="button" value="Create Credit Item" onclick="return add_credit();" />        </div>    </div>    <!--end:step 2-->    <div id="step_3"  class="step_form" style="display:none;">        <p class="highlight">The memo provides transparency for the invoiced party by explaining the purpose of the invoice.</p>        <fieldset>            <div class="pad24t">            <?php            echo $af->richtext('billing[memo]', '', '250', 0);            ?>            </div>        </fieldset>    </div>    <!--start:step 3-->    <div id="step_4" class="step_form" style="display:none;">        <p class="highlight">If this invoice requires shipping information, input it below. Billing information is automatically populated in step when based on the member/contact you selected.</p>        <fieldset>            <div class="pad24t">                <label>Shipping?</label>                <?php                echo $af->radio('ship_yesno', '0', array('0' => 'No shipping Required', '1' => 'Shipping required'))                ?>                <div id="shipping_show" style="display:none;">                    <hr >                    <div class="col25l">                        <label>Select a Shipping Method</label>                        <div class="radioInputs">                            <?php                            $cart = new cart;                            $opts = $cart->get_flat_shipping('', 'array');                            foreach ($opts as $item) {                                ?>                                <input type="radio" id="shipping<?php $item['id'] ?>" name="shipping[id]" value="<?php echo $item['id']; ?>" />                                <label for="shipping<?php $item['id'] ?>" class="checking"><?php echo $item['name'] . ' (' . $item['format_price'] . ')' ?></label>                                <?php                            }                            ?>                        </div>                    </div>                    <div class="col75r padLeft formFull">                        <label>Input Shipping Address</label>                        <?php                        echo $af->checkbox('same_as_billing', 'Same as shipping information');                        ?>                        <div id="shipForm">                        <?php                        echo $af->addressForm('shipping');                        ?>                        </div>                    </div>                    <div class="clear"></div>                </div>            </div>        </fieldset>    </div>    <!--end:step 3-->    </form>    <script src="<?php echo PP_ADMIN; ?>/js/form_builder.js" type="text/javascript"></script>    <script src="<?php echo PP_ADMIN; ?>/js/forms.js" type="text/javascript"></script>    <script src="<?php echo PP_ADMIN; ?>/js/form_steps.js" type="text/javascript"></script>    <script type="text/javascript">        $(document).ready(function() {            $("input[type=radio]['data[member_type]']").change(function() {                switch(this.value) {                    case 'member':                        return swap_multi_div('member','contact,new_contact');                    case 'contact':                        return swap_multi_div('contact','member,new_contact');                    case 'new_contact':                        return swap_multi_div('new_contact','contact,member');                }            });            $("input[type=radio]['data[ship_yesno]']").change(function() {                switch(this.value) {                    case '1':                        return show_div('shipping_show');                    case '0':                        return hide_div('shipping_show');                }            });            $("input[type=checkbox]['same_as_billing']").bind('change', function(){                var checked = this.checked;                if (checked) {                    $("#shipForm :input").attr("disabled", true);                } else {                    $("#shipForm :input").attr("disabled", false);                }            });        });        var inner_option = 0;        function add_existing_product() {            inner_option += 1;            var id = Math.random() * 100000;            var id1 = Math.random() * 100000;            row = '<tr id="troption-' + inner_option + '">';            // row += '<td><input type="hidden" name="components[' + inner_option + '][type]" value="product" />';            row += '<td><input type="hidden" name="components[' + inner_option + '][type]" value="product" /><input placeholder="Type a product name or click the icon to the right..." type="text" value="" name="p_dud" id="C' + inner_option + '" autocomplete="off" onkeyup="return autocom(this.id,\'id\',\'name\',\'ppSD_products\',\'name\',\'product\');" style="width:95%;" />';            row += '<a href="null.php" onclick="return get_list(\'products\',\'C' + inner_option + '_id\',\'C' + inner_option + '\');"><img src="imgs/icon-list.png" width="16" height="16" border="0" alt="Select from list" title="Select from list" class="icon-right"/></a>';            row += '<input type="hidden" name="components[' + inner_option + '][id]" id="C' + inner_option + '_id" value="" /></td>';            //row += '<input type="text" name="components[' + inner_option + '][name]" value="" style="width:100%;" class="req" id="A' + inner_option + '" /></td>';            row += '<td><input type="text" name="components[' + inner_option + '][qty]" value="1" style="width:100%;" class="req" id="B' + inner_option + '" /></td>';            row += '<td>--</td>';            row += '<td><input type="checkbox" name="components[' + inner_option + '][tax]" value="1" /></td>';            row += '<td><img src="imgs/icon-delete.png" width="16" height="16" border="0" alt="Remove" title="Remove" class="hover" onclick="return delete_inner_option(\'' + inner_option + '\');" /></td>';            row += '</tr>';            $('#components tbody').append(row);            return false;        }        function add_credit() {            inner_option += 1;            var id = Math.random() * 100000;            var id1 = Math.random() * 100000;            row = '<tr id="troption-' + inner_option + '">';            row += '<td><input type="hidden" name="components[' + inner_option + '][type]" value="credit" /><input type="text" placeholder="Name for this credit" name="components[' + inner_option + '][name]" class="req" id="A' + inner_option + '" style="width:100%;" /><textarea placeholder="Description for this credit" name="components[' + inner_option + '][desc]" style="width:100%;height:85px;margin-top:6px;"></textarea></td>';            row += '<td>--</td>';            row += '<td><input type="text" name="components[' + inner_option + '][price]" value="" placeholder="0.00" style="width:100%;" class="req" id="B' + inner_option + '" /></td>';            row += '<td><input type="checkbox" name="components[' + inner_option + '][tax]" value="1" /></td>';            row += '<td><img src="imgs/icon-delete.png" width="16" height="16" border="0" alt="Remove" title="Remove" class="hover" onclick="return delete_inner_option(\'' + inner_option + '\');" /></td>';            row += '</tr>';            $('#components tbody').append(row);            return false;        }        function add_hourly() {            inner_option += 1;            var id = Math.random() * 100000;            var id1 = Math.random() * 100000;            row = '<tr id="troption-' + inner_option + '">';            row += '<td><input type="hidden" name="components[' + inner_option + '][type]" value="hourly" /><input type="text" name="components[' + inner_option + '][name]" value="" style="width:100%;" class="req" id="B' + inner_option + '" placeholder="Name of the services rendered" /><textarea name="components[' + inner_option + '][desc]" style="width:100%;height:85px;margin-top:6px;" placeholder="Description of the services rendered"></textarea></td>';            row += '<td><input type="text" name="components[' + inner_option + '][qty]" value="1" style="width:100%;" class="req" id="A' + inner_option + '" /> <select name="components[' + inner_option + '][hourtype]"><option value="hours">Hours</option><option value="minutes">Minutes</option></select></td>';            row += '<td>--</td>';            row += '<td><input type="checkbox" name="components[' + inner_option + '][tax]" value="1" /></td>';            row += '<td><img src="imgs/icon-delete.png" width="16" height="16" border="0" alt="Remove" title="Remove" class="hover" onclick="return delete_inner_option(\'' + inner_option + '\');" /></td>';            row += '</tr>';            $('#components tbody').append(row);            return false;        }        function add_inner_option() {            inner_option += 1;        }        function delete_inner_option(id) {            $('#troption-' + id).remove();            return false;        }    </script><?php}