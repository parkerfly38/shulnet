<?php/** * * * Zenbership Membership Software * Copyright (C) 2013-2016 Castlamp, LLC * * This program is free software: you can redistribute it and/or modify * it under the terms of the GNU General Public License as published by * the Free Software Foundation, either version 3 of the License, or * (at your option) any later version. * * This program is distributed in the hope that it will be useful, * but WITHOUT ANY WARRANTY; without even the implied warranty of * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the * GNU General Public License for more details. * * You should have received a copy of the GNU General Public License * along with this program.  If not, see <http://www.gnu.org/licenses/>. * * @author      Castlamp * @link        http://www.castlamp.com/ * @link        http://www.zenbership.com/ * @copyright   (c) 2013-2016 Castlamp * @license     http://www.gnu.org/licenses/gpl-3.0.en.html * @project     Zenbership Membership Software */if (! empty($_POST['id'])) {    $data      = new history($_POST['id'], '', '', '', '', '', 'ppSD_criteria_cache');    $cid       = $data->final_content['id'];    $type      = $data->final_content['type'];    $act       = $data->final_content['act'];    $save      = $data->final_content['save'];    $name      = $data->final_content['name'];    $public    = $data->final_content['public'];    $inclusive = $data->final_content['inclusive'];    $act_id    = $data->final_content['act_id'];    $datae     = unserialize($data->final_content['criteria']);    if ($datae['all'] == '1') {        $all = '1';    } else {        $all = '0';    }    $editing = '1';    $act_id = '';} else {    $cid       = 'new';    $type      = $_POST['type'];    $act       = $_POST['act'];    $save      = '';    $all       = 0;    $public    = 1;    $inclusive = 'and';    $name      = '';    $datae     = array(        'filters'       => array(),        'filter_type'   => array(),        'filter_tables' => array(),    );    $editing   = '0';    if (! empty($_POST['act_id'])) {        $act_id = $_POST['act_id'];    } else {        $act_id = '';    }}?><script type="text/javascript">    $.ctrl('S', function () {        return json_add('criteria-add', '<?php echo $cid; ?>', '<?php echo $editing; ?>', 'popupform');    });</script><form action="" method="post" id="popupform"      onsubmit="return json_add('criteria-add','<?php echo $cid; ?>','<?php echo $editing; ?>','popupform');"><input type="hidden" name="type" value="<?php echo $type; ?>"/><input type="hidden" name="act" value="<?php echo $act; ?>"/><input type="hidden" name="act_id" value="<?php echo $act_id; ?>"/><div id="popupsave">    <input type="button" value="Preview" id="preview_but" class="" onclick="return preview_criteria('popupform');"/>    <input type="submit" value="Save" class="save"/></div><h1>Criteria Builder</h1><ul id="theStepList">    <li class="on" onclick="return goToStep('0');">Overview</li>    <li onclick="return goToStep('1');">Criteria</li></ul><div id="pop_inner" class="pad24t popupbody"><?phpif ($act == 'campaign') {    echo "<p class=\"highlight smaller\">Before we can set up your campaign, you will need to set up criteria for who will receive this campaign. Please build this criteria below.</p>";}?><script type="text/javascript">    function check_submit() {        if ($('#load_saved').val()) {            return json_add('criteria-add', '<?php echo $cid; ?>', '<?php echo $editing; ?>', 'popupform');        }    }</script><script src="js/form_rotator.js" type="text/javascript"></script><ul id="formlist"><li class="form_step">    <fieldset>        <legend>Load Saved Criteria</legend>        <div class="pad24t">            <select id='load_saved' name="load_saved" style="width:300px;" onchange="return check_submit();">                <?php                echo $admin->saved_criteria_list($type);                ?>            </select>        </div>    </fieldset>    <?php    if ($act == 'content_access') {    ?>    <fieldset>        <legend>Content</legend>        <div class="pad24t">            <div class="field">                <label>Period</label>                <div class="field_entry">                    <?php                    echo $admin->timeframe_field('timeframe', '010000000000', '1', '0');                    ?>                    <p class="field_desc_show">For how long would you like to grant these members access to this content?</p>                </div>            </div>        </div>    </fieldset>    <?php    }    ?>    <fieldset style="min-height:600px;">        <legend>Basic Details</legend>        <div class="pad24t">            <?php            if ($act == 'campaign') {                echo "<input type=\"hidden\" name=\"name\" value=\"Campaign Criteria\" />";                echo "<input type=\"hidden\" name=\"save\" value=\"1\" />";            } else {                ?>                <div class="field">                    <label>Name</label>                    <div class="field_entry">                        <input type="text" id="name" value="<?php echo $name; ?>" name="name" style="width:250px;"                               class="filterinputtype"/>                        <p class="field_desc_show">Reference name for this criteria?</p>                    </div>                </div>                <div class="field">                    <label>Save</label>                    <div class="field_entry">                        <input type="radio" name="save" value="1" <?php if ($save == '1') {                            echo "checked=\"checked\"";                        } ?> /> Yes <input type="radio" name="save" value="0" <?php if ($save != '1') {                            echo "checked=\"checked\"";                        } ?> /> No                        <p class="field_desc_show">Save criteria for later use in searching and emails?</p>                    </div>                </div>                <div class="field">                    <label>Privacy</label>                    <div class="field_entry">                        <input type="radio" name="public" value="1" <?php if ($public == '1') {                            echo "checked=\"checked\"";                        } ?> /> Public <input type="radio" name="public" value="0" <?php if ($public != '1') {                            echo "checked=\"checked\"";                        } ?> /> Private                        <p class="field_desc_show">Make available to everyone or just you?</p>                    </div>                </div>            <?php            }            ?>            <div class="field">                <label>Criteria</label>                <div class="field_entry">                    <input type="radio" name="criteria" value="1"                           onclick="return show_div('add_options');" <?php if ($all != '1') {                        echo "checked=\"checked\"";                    } ?> /> Specific <?php echo $type; ?>s matching criteria.<br/><input type="radio" name="criteria"                                                                                         value="0"                                                                                         onclick="return hide_div('add_options');" <?php if ($all == '1') {                        echo "checked=\"checked\"";                    } ?> /> All <?php echo $type; ?>s                </div>            </div>            <div class="field">                <label>Type</label>                <div class="field_entry">                    <input type="radio" name="inclusive" value="and" <?php if ($inclusive == 'and') {                        echo "checked=\"checked\"";                    } ?> /> Must match all criteria.<br/><input type="radio" name="inclusive"                                                                value="or" <?php if ($inclusive == 'or') {                        echo "checked=\"checked\"";                    } ?>  /> Must match any criteria                </div>            </div>        </div>    </fieldset></li><li class="form_step">    <div class="field" style="margin-top:24px;">        <label>Add a Field</label>        <div class="field_entry">            <select id="add_field">                <option value=""></option>                <?php                if ($type == 'member') {                    $array = $admin->get_scope_fields('member', 'array');                } else {                    $array = $admin->get_scope_fields('contact', 'array');                }                foreach ($array as $item) {                    echo "<option value=\"" . $item['id'] . "\">" . $item['name'] . "</option>";                }                ?>            </select>        </div>    </div>    <fieldset style="min-height:700px;display:<?php if ($all == '1') {        echo "none";    } else {        echo "block";    } ?>;" id="add_options">        <legend>Criteria Fields</legend>        <div class="pad24t">            <div id="possible_fields">                <?php                foreach ($datae as $fname => $options) {                    if (is_array($options)) {                        foreach ($options as $anOption) {                            echo $admin->cell_criteria($type, $fname, $anOption['value'], $anOption['eq']);                        }                    }                }                ?>            </div>        </div>    </fieldset></li></ul></div></div></div></form><script type="text/javascript">    var repSo = '';    $(document).ready(function () {        $('#add_field').live('change', function () {            return add_criteria($(this).val());        });    });    function add_criteria(id, value, eq) {        repSo = '';        show_loading();        send_data = 'type=<?php echo $type; ?>&id=' + id + '&value=' + value + '&eq=' + eq;        $.post('cp-functions/criteria_field.php', send_data, function (repSo) {            if (debug == '1') {                console.log(repSo);            }            $('#possible_fields').append(repSo);            $('#add_field').val('');            close_loading();        });        return false;    }    function remove_criteria(id) {        $('#' + id).remove();    }</Script>